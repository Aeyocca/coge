<SCRIPT language="JavaScript" type="text/javascript" src="./js/jquery.tablesorter.2.0.3.js"></SCRIPT>
<script language="javascript">

$(function() {
 $(".dialog").dialog({ autoOpen: false} );
 });

function ajax_wait (val){
if (ajax.length)
   {
    setTimeout("ajax_wait("+'"'+val+'"'+")",100);
    return;
   }
  eval(val);
}
$.fn.getLength = function(val){
  var opt_length;
  var blastable;
  this.each(
        function()
        {
                var opts = this.options;
                opt_length = opts.length;
                if (opt_length == 0) {return opt_length;}
                blastable = opts[0].id;
                if (val){
                  for(var i=1;i<opts.length;i++)
                  {
                        blastable += ","+opts[i].id;
                        //need to chopoff last comma
                  }
                }
        }
  );
  if(val) return blastable;
  else return opt_length;
};

function send_to_GenoList(){
  var check = $('#genomelist_choice').getLength();
  if(($('#blank').val())||(check==0)){
    alert('You have not selected any Genomes to examine. You must select at least one.');
    return;
  }
  var genolist = $('#genomelist_choice').getLength(1);
  parse_for_GenoList(['args__'+genolist],[send_to_url]);
}

function add_all_genomes(){
	$('#dsg_id option').each(function(){
		add_to_genomelist_nowarn($(this).text(),$(this).attr("value"));
	});
	$('#geno_list').dialog('option', 'width', 500).dialog('open');
}


function send_to_url(url){
  window.open(url);
}

function add_to_genomelist_nowarn(genome_name,gstid)
{
	var check = $('#'+gstid).val();
	  if (check){
	   
	   return;
	  }else{
	  var html = '<option id='+gstid+' value='+gstid+ ' >'+genome_name+'</option>';
	  //alert(html);
	  $('#blank').remove();
	  $('#genomelist_choice').append(html);
	  counting();
	}
}

function add_to_genomelist(genome_name,gstid)
{
	var check = $('#'+gstid).val();
	  if (check){
	   alert('You have already added '+genome_name+'.');
	   return;
	  }
	  var html = '<option id='+gstid+' value='+gstid+ ' >'+genome_name+'</option>';
	  //alert(html);
	  $('#blank').remove();
	  $('#genomelist_choice').append(html);
	  counting();
	
}

function open_aa_usage_table (html)
{
 $('#aa_usage_table').html(html);
 $('#aa_table').tablesorter(); 
}


function clear_genome_list(){
	var listlength = $('#genomelist_choice')[0].length;
	for(var i=0; i < listlength; i++)
	{
		$('#'+$('#genomelist_choice')[0][0].id).remove();
	}
	counting();
}

function counting(){
	var count=0;
	if($('#blank').val()){ count =0;} 
	else { count = $('#genomelist_choice')[0].length;}
	if(count==0) { $('#genomelist_choice').html('<option id=blank value=null>No genome selected</option>') ; }
	$('#count').html('Genome Count:'+count);
}

function add_all_org(){
	$("#org_id option").each(function(){
		 get_genome_list_for_org(['args__oid','args__'+$(this).attr('value')],[add_all_genomes_from_org]);
	});
	
}


function add_all_genomes_from_org(val){
	if(val.length>0){
		
		var genomes = val.split("&&");
		var i=0;
		for(i=0; i < genomes.length;i++){
			var genome = genomes[i].split('%%');
			if(genome.length>1){
				add_to_genomelist_nowarn(genome[1],genome[0]);
			}
		}
		
	}
}


function get_organism_name_chain(val)
{
 get_orgs(['args__name','args__'+val, 'args__dsgid','dsg_id'], [get_org_info_chain]);	 
}

function get_organism_desc_chain(val)
{
 get_orgs(['args__desc','args__'+val, 'args__dsgid','dsg_id'], [get_org_info_chain]);	 
}

function get_org_info_chain(val, val2)
 {
  if (val) {$('#org_list').html(val);}
  if (val2) {$('#org_count').html(val2);}
  get_org_info(['args__oid','org_id'],[dataset_group_chain]);
 }


function get_dataset_name_chain(val)
{ 
 if (val){
    get_dataset(['args__dsname','args__'+val], [dataset_info_chain]);
    $('#org_list').html('<hidden id=org_id>');
//    $('#org_info').html(' ');
    $('#org_count').html(' ');
    $('#dsg_list').html('<hidden id=dsg_id>');
    $('#dsg_info').html(' ');
    $('#dsg_count').html(' ');
   }
 else {get_orgs([],[dataset_chain])};
}


function dataset_group_chain(val) {
   if (val) {$('#org_info').html(val);}
   get_dataset_groups(['args__oid','org_id','args__dsgid','dsg_id'],[dataset_group_info_chain]);
   $('#dsg_list').html('<hidden id=dsg_id>');;
   $('#dsg_count').empty();	
   $('#dsg_info').empty();	
   $('#ds_list').html('<hidden id=ds_id>');
   $('#ds_count').empty();	
   $('#ds_info').empty();	
   $('#chr_list').empty();
   $('#chr_count').empty();	
   $('#chr_info').empty();	
   $('#viewer').empty();
   $('#get_seq').empty();
}

function dataset_group_info_chain(val, val2) {
  if (val) {$('#dsg_list').html(val);}
  if (val2) {$('#dsg_count').html(val2);}
  $('#dsg_info').html('<span class="small alert">loading. . .</span>');
  get_dataset_group_info(['args__dsgid','dsg_id'],[dataset_chain]);
}

function dataset_chain(val)
{
 if (val) {$('#dsg_info').html(val);}
 get_dataset(['args__dsgid','dsg_id'],[dataset_info_chain]);
}

function recent_dataset_chain() {
 get_dataset(['args__oid','recent_org_id'],[dataset_info_chain]);
}

function dataset_info_chain(val, val2) {
 if (val) {$('#ds_list').html(val);}
 if (val2) {$('#ds_count').html(val2);}
 $('#ds_info').html('<span class="small alert">loading. . .</span>');
 $('#chr_list').empty();
 $('#chr_count').empty();	
 $('#chr_info').empty();	
 $('#viewer').empty();
 $('#get_seq').empty();
get_dataset_info(['ds_id'],[dataset_chr_info_chain]);

}

function dataset_chr_info_chain(val, val2, val3) {
 if (val) {$('#ds_info').html(val);}
 if (val2) {$('#chr_list').html(val2);}
 if (val3) {$('#chr_count').html(val3);}	
 $('#viewer').empty();
 $('#get_seq').empty();
 $('#feature_count_data').empty();
 get_dataset_chr_info(['ds_id', 'chr', 'dsg_id'],[populate_dataset_chr_info]);
}


function populate_dataset_chr_info (chr_info, viewer, get_seq){
 $('#chr_info').html(chr_info);
 $('#viewer').html(viewer);
 $('#get_seq').html(get_seq);
 setup_button_states(); //get them buttons working!
}

function launch_seqview(dsgid, chr, dsid)
 {
   start = $('#start').val();
   stop = $('#stop').val();
   window.open("SeqView.pl?dsgid="+dsgid+"&dsid="+dsid+"&chr="+chr+"&start="+start+"&stop="+stop);
 }


function launch_viewer (dsgid, chr) {
 x = $('#x').val();
 z = $('#z').val();
 if (z > 12) {z=12;}
 link =  "GenomeView.pl?z="+z+"&x="+x+"&dsgid="+dsgid+"&chr="+chr;
 window.open(link);
}
function timing(val){
  var searchterm;
  if (val == "org_name") 
   {
    searchterm = $('#org_name').val();
   }
  else if (val == "org_desc")
   {
    searchterm = $('#org_desc').val();
   }
  else if (val == "ds_name")
   {
    searchterm = $('#ds_name').val();
    if (!searchterm) {val=0;}
   }
  if (!searchterm) {val=0;}
  if(searchterm == "Search")
  {
    searchterm = "";
  }

  if (pageObj.search && pageObj.search == searchterm)
   {
//    return;
   }
  pageObj.search=searchterm;
  if (pageObj.time){
   clearTimeout(pageObj.time);
  }
  if (val == "org_name") 
   {
     pageObj.time = setTimeout("get_organism_name_chain($('#org_name').val())",500);
   }
  else if (val == "org_desc")
   {
     pageObj.time = setTimeout("get_organism_desc_chain($('#org_desc').val())",500);
   }
  else if (val == "ds_name")
   {
     pageObj.time = setTimeout("get_dataset_name_chain($('#ds_name').val())",500);
   }
}

$(document).ready(function(){
  if($('#org_name').val() && $('#org_name').val() != "Search") {
    $('#org_name').css({fontStyle: "normal"});
    if($('#org_list').html()) {get_org_info(['args__oid','org_id'],[dataset_group_chain]);} else {timing('org_name')};
  }  
  if($('#org_desc').val() && $('#org_desc').val() != "Search") {
    $('#org_desc').css({fontStyle: "normal"});
    timing('org_desc');
  }  
  if($('#ds_name').val() && $('#ds_name').val() != "Search") {
    $('#ds_name').css({fontStyle: "normal"});
    if ($('#ds_list').html() == "undefined") {
     timing('ds_name');
    } else { dataset_info_chain();}
     
  }

  //set up jquery ajax
  $.ajaxSetup({
                type: "GET",
                url: "/CoGe/OrganismView.pl",
                //dataType: "html",
                cache: false,
        });

 });

//ajax function call

function get_feat_gc(opts){
 if (!opts){opts={};}
 chr = opts.chr;
 typeid = opts.typeid;
 min = $('#feat_gc_min').val();
 max = $('#feat_gc_max').val();
 hist_type = $('#feat_hist_type').val();
 dsid = opts.dsid;
 dsgid = $('#dsg_id').val();
  
 $.ajax({
   data: {
	  jquery_ajax: 1,
          fname: 'get_gc_for_feature_type',
	  dsid: dsid,
	  dsgid: dsgid,
	  typeid: typeid,
	  chr: chr,
	  min: min,
	  max: max,
	  hist_type: hist_type,
         },
   success: function(data) {$('#gc_histogram').html(data);}
 });
 $('#gc_histogram').html('loading. . .');

}


function search_bar(div_id){
  if($('#'+div_id).val() == "Search") $('#'+div_id).val("").css({fontStyle: "normal"});
}

function restore_search_bar(div_id){
  if(! $('#'+div_id).val()) {
    $('#'+div_id).val("Search").css({fontStyle: "italic"});
  }
}

function changeColor(id, color) {
  document.getElementById(id).style.color = color;
}

$(function() {
 //substaniate dialog boxes	     
        $(".dialog_box").dialog({ autoOpen: false, width: 500 });
});

function make_dsg_public (dsgid) {
 $.ajax({
        data: {
     	   jquery_ajax: 1,
	   fname: 'make_genome_public',
	   dsgid: dsgid,
           },
        success : function(val) {
	      if (val != 1) {alert(val);}
	      get_dataset_group_info(['args__dsgid','dsg_id'],[dataset_chain]);
	},
      });
}

function make_dsg_private (dsgid) {
 $.ajax({
        data: {
     	   jquery_ajax: 1,
	   fname: 'make_genome_private',
	   dsgid: dsgid,
           },
        success : function(val) {
	      if (val != 1) {alert(val);}
	      get_dataset_group_info(['args__dsgid','dsg_id'],[dataset_chain]);
	},
      });
}

</script>
<TABLE>
   <TR><TD valign=top>
    <table class="ui-widget-content ui-corner-all">
     <tr>
       <td>Organism Name:<td><input type="text" size=15 value="<TMPL_VAR NAME="ORG_NAME">" name = "org_name" id="org_name" style="font-style:italic" onFocus="search_bar('org_name')" onKeyUp='timing("org_name");'><span class='ui-button ui-corner-all' onClick="timing('org_name');"><span class="ui-icon ui-icon-arrowrefresh-1-w"></span></span>
     <tr>
       <td>Organism Description:<td><input type="text" size=15 value="<TMPL_VAR NAME="ORG_DESC">" name = "org_desc" id="org_desc" style="font-style:italic" onFocus="search_bar('org_desc')" onKeyUp='timing("org_desc");'><span class='ui-button ui-corner-all' onClick="timing('org_desc');"><span class="ui-icon ui-icon-arrowrefresh-1-w"></span></span>
     <tr>
       <td>Dataset Name:<td><input type="text" size=15 value="<TMPL_VAR NAME="DS_NAME">" name = "ds_name" style="font-style:italic" id="ds_name" onFocus="search_bar('ds_name')" onKeyUp='timing("ds_name");' ><span class='ui-button ui-corner-all' onClick="timing('ds_name');"><span class="ui-icon ui-icon-arrowrefresh-1-w"></span></span>
   </table>
  <tr><td>
   <span>Organisms: </span><span class=small id=org_count><TMPL_VAR NAME="ORG_COUNT"></span> 
   <DIV id="org_list"><TMPL_VAR NAME="ORG_LIST"></DIV>
   <span class="ui-button ui-corner-all" id=allorg onClick="add_all_org();$('#geno_list').dialog('option', 'width', 500).dialog('open');">Add all to Genome List</span><br>
   <td valign=top>
   <DIV>Organism information</DIV>
   <div id=org_info class = "small ui-corner-all ui-widget-content" ></div>
  <tr valign=top>
  <td>
  <span>Genomes: </span><span class=small id=dsg_count><TMPL_VAR NAME="DSG_COUNT"></span> 
  <DIV style="vertical-align: top;" id ="dsg_list"><TMPL_VAR NAME="DSG_LIST"></DIV>
  <TD valign=top>
   <DIV>Genome information</DIV>
   <DIV id="dsg_info" class = "small ui-corner-all ui-widget-content"><TMPL_VAR NAME="DSG_INFO"></DIV>
	
  <tr  valign=top>
  <td>
   <span>Datasets: </span><span class=small id=ds_count><TMPL_VAR NAME="DS_COUNT"></span> 
   <DIV style="vertical-align: top;" id="ds_list"><TMPL_VAR NAME="DS_LIST"></DIV>
  <TD valign=top>
   <DIV>Dataset information</DIV>
   <DIV id="ds_info" class = "small ui-corner-all ui-widget-content" ><TMPL_VAR NAME="DS_INFO"></DIV>
  <tr  valign=top>
  <td>
   <span>Chromosomes: </span><span class=small id=chr_count><TMPL_VAR NAME="CHR_COUNT"></span> 
   <DIV style="vertical-align: top;" id="chr_list"><TMPL_VAR NAME="CHR_LIST"></DIV>
  <TD valign=top>
   <DIV>Chromosome information</DIV>
   <DIV id="chr_info" class = "small ui-corner-all ui-widget-content" ><TMPL_VAR NAME="CHR_INFO"></DIV>
  <tr valign=top>
	<td>
  <DIV id="gn_list"  ><TMPL_VAR NAME="GN_LIST"></DIV>

<!--   <td valign=top>
   Organisms With Recently Added Datasets:
    <DIV id="recent_orgs"><a href="#" onclick="get_recent_orgs([],['recent_orgs']);">Show</a></DIV>-->

<TR nowrap>
  <TD colspan=2 align=left valign=top nowrap>
   <DIV style="vertical-align: top; float: left;" id="viewer"></DIV>
   <DIV style="vertical-align: top; float: left;" id="get_seq"></DIV>
</Table>





<div class="dialog_box" id="gc_histogram" title="Histogram of GC Content"><input type=hidden id=feat_gc_min></div>
<div class="dialog_box" id="wobble_gc_histogram" title="Histogram of Wobble GC Content for CDS"></div>
<div class="dialog_box" id="wobble_gc_diff_histogram" title="(CDS GC - wobble GC) Content Histogram"></div>
<div class="dialog_box" id="codon_usage_table" title="Codon Usage Table"></div>
<div class="dialog_box" id="aa_usage_table" title="Amino Acid Usage Table"></div>



<div class="dialog" title="Genome List" id="geno_list">
    <span id=count class="small count">Genome Count: 0</span><br>
             <select id="genomelist_choice" SIZE="10" MULTIPLE >
              <option id=blank value=null>No Genome Selected</option>
              </select>
 <br>
    <span class="ui-button ui-corner-all" id=send onClick="$('#genomelist_choice').sortSelect()">Sort List Alphabetically</span><br><br>
    <span class="ui-button ui-corner-all" id=send onClick="send_to_GenoList()">Create Genome List</span><br><br>
      <span class="ui-button ui-corner-all" id=remove onClick="$('#'+$('#genomelist_choice').val()).remove();counting();">Remove</span><br><br>
    <span class="ui-button ui-corner-all" id=clear onClick="clear_genome_list()">Clear</span><br>

    <div id=add_all_search></div>
</div>
