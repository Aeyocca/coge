<TMPL_IF NAME="MAIN">
<script src="./js/coge/exporter.js"></script>
<SCRIPT language="JavaScript" type="text/javascript" src="./js/jquery.tablesorter.2.0.3.js"></SCRIPT>
<SCRIPT language="JavaScript" type="text/javascript" src="./js/jquery.tablesorter.pager.js"></SCRIPT>
<SCRIPT language="JavaScript" type="text/javascript" src="./js/jquery.fileupload.js"></SCRIPT>
<SCRIPT language="JavaScript">

$(document).ready(function() {
    pageObj = new Object();
    pageObj.timers = new Array();

    exporter = new coge.exporter(
        "#export_irods_dialog", {
        fname: "export_experiment_irods",
        eid: "<tmpl_var name=eid>"
    });

    $.ajaxSetup({
        type: "GET",
        url: "<TMPL_VAR NAME='PAGE_NAME'>",
        dataType: "html",
        cache: false,
    });

    $(".dialog_box").dialog({autoOpen: 0, width: 450});

    $("#edit_type_name").autocomplete({
        source: function() { get_experiment_types(); },
        select: function(event, ui) { get_type_description( ui.item.label ); }
    });

    set_annotation_table();

    init_annotation_dialog(<TMPL_VAR NAME="EID">, '<TMPL_VAR NAME="DEFAULT_TYPE">');
});

function set_annotation_table() {
    $('#experiment_annotation_table').tablesorter({widgets: ['zebra']});
}

function download_files() {
    var success = $.ajax({
        url: "<tmpl_var name=PAGE_NAME>",
        dataType: "json",
        data: {
            fname: "get_file_urls",
            eid: <tmpl_var name="eid">,
        },
        success: function(json) {
            console.log(json.files);
            json.files.forEach(window.open);
        }
    })
}

function get_experiment_info() {
    $.ajax({
        data: {
            fname: 'get_experiment_info',
            eid: "<TMPL_VAR NAME='EID'>",
        },
        success : function (data) {
            $('#experiment_info').html(data);
        }
    });
}

function edit_experiment_info() {
    $.ajax({
        data: {
            fname: 'edit_experiment_info',
            eid: "<TMPL_VAR NAME='EID'>",
        },
        success : function(data) {
            var obj = jQuery.parseJSON(data);
            $("#experiment_info_edit_box").html(obj.output).dialog('open');
        },
    });
}

function update_experiment_info (){
    var name = $('#edit_name').val();
    if (!name) {
        alert('Please specify a name.');
        return;
    }

    var version = $('#edit_version').val();
    if (!version) {
        alert('Please specify a version');
        return;
    }

    var source_id = parseInt( $('#edit_source_id').val() );
    if (!source_id) {
        alert('Please specify a source');
        return;
    }

    var desc = $('#edit_desc').val();

    $.ajax({
        data: {
            fname: 'update_experiment_info',
            eid: "<TMPL_VAR NAME='EID'>",
            name: name,
            desc: desc,
            source_id: source_id,
            version: version
        },
        success : function(val) {
            get_experiment_info();
            $("#experiment_info_edit_box").dialog('close');
        }
    });
}

function get_sources () {
    $.ajax({
        data: {
            fname: 'get_sources'
        },
        success : function(data) {
            var items = jQuery.parseJSON(data);
            $("#edit_source").autocomplete("option", "source", items).autocomplete("search");
        }
    });
}

function make_experiment_public () {
    $.ajax({
        data: {
            fname: 'make_experiment_public',
            eid: "<TMPL_VAR NAME='EID'>"
        },
        success : function(val) {
            get_experiment_info();
        }
    });
}

function make_experiment_private () {
    $.ajax({
        data: {
            fname: 'make_experiment_private',
            eid: "<TMPL_VAR NAME='EID'>"
        },
        success : function(val) {
            get_experiment_info();
        }
    });
}

function add_experiment_type () {
    $.ajax({
        data: {
            fname: 'add_experiment_type',
            eid: "<TMPL_VAR NAME='EID'>"
        },
        success : function(data) {
            $("#experiment_type_edit_box").dialog({
                beforeClose:
                    function() {
                        $("#edit_type_name").autocomplete('close');
                    }
            });
            $("#experiment_type_edit_box").html(data).dialog('open');
        }
    });
}

function add_type_to_experiment () {
    var name = $('#edit_type_name').val();
    var description = $('#edit_type_description').val();

    if (name) {
        $.ajax({
            data: {
                fname: 'add_type_to_experiment',
                eid: "<TMPL_VAR NAME='EID'>",
                name: name,
                description: description
            },
            success : function(val) {
                get_experiment_info();
                $("#experiment_type_edit_box").dialog('close');
            },
        });
    }
    else { alert ('Error: Must have type name specified!');}
}

function export_data() {
    if (!check_and_report_login()) return;

    exporter.export();
}

function check_login() {
    var logged_in = false;

    $.ajax({
        async: false,
        data: {
            fname: 'check_login'
        },
        success : function(rc) {
            logged_in = rc;
        }
    });

    return logged_in;
}

function check_and_report_login() {
    if (!check_login()) {
        alert('Your session has expired, please log in again.');
        location.reload(true);
        return false;
    }
    return true;
}

function remove_experiment_type (opts) {
    etid = opts.etid;
    $.ajax({
        data: {
            fname: 'remove_experiment_type',
            eid: "<TMPL_VAR NAME='EID'>",
            etid: etid,
        },
        success : function(val) {
            get_experiment_info();
        },
    });
}

function get_annotations() {
    $.ajax({
        data: {
            fname: 'get_annotations',
            eid: "<TMPL_VAR NAME='EID'>",
        },
        success : function(data) {
            $('#experiment_annotations').html(data);
            set_annotation_table();
        }
    });
}

function remove_annotation (eaid) {
    $.ajax({
        data: {
            fname: 'remove_annotation',
            eid: "<TMPL_VAR NAME='EID'>",
            eaid: eaid,
        },
        success : function() {
            get_annotations();
        },
    });
}

function get_experiment_types () {
    $.ajax({
        data: {
            fname: 'get_experiment_types'
        },
        success : function(val) {
            var items = jQuery.parseJSON(val);
            $("#edit_type_name").autocomplete("option", "source", items).autocomplete("search");
        },
    });
}

function get_type_description (name) {
    $.ajax({
        data: {
            fname: 'get_type_description',
            name: name
        },
        success : function(data) {
            $("#edit_type_description").html(data);
        },
    });
}
</SCRIPT>

<section class="coge-margin-bottom">
    <div style="color:dimgray;font-weight:bold;">Experiment Info</div>
    <div id='experiment_info' class="inline">
        <TMPL_VAR NAME="EXPERIMENT_INFO">
    </div>
    <div class="small inline top" style="padding-left: 10px;">
        <ul class="ui-widget-content ui-corner-all" style="padding: 2px;">
            <li>
                <span class="title5">Rows:</span>
                <span class="data5"><tmpl_var name=rows><span>
            </li>
            <li>
                <span class="title5">iPlant Data Store:</span>
                <span class="data5 link" ondblclick="export_data()" onclick="export_data()">Export data</span>
            </li>
            <li>
                <span class="title5">Download:</span>
                <span class="data5 link" onclick="download_files();">Experiment Data</span>
            </li>
        </ul>
        <a style="font-size: .9em; color: black;" target="_blank" class='ui-button ui-corner-all ui-button-icon-right' href="<tmpl_var name=link>">
            View
            <span class="ui-icon ui-icon-extlink"></span>
        </a>
    </div>
</section>
<br>
<TMPL_IF NAME="EXPERIMENT_ANNOTATIONS">
<div>
 <div style="color:dimgray;font-weight:bold;">Experiment Annotations</div>
 <div id="experiment_annotations">
  <TMPL_VAR NAME="EXPERIMENT_ANNOTATIONS">
 </div>
</div>
</TMPL_IF>

<div id="experiment_info_edit_box" class="dialog_box" title="Edit Experiment Info" style="display:none;"></div>

<div id="experiment_type_edit_box" class="dialog_box" title="Add Experiment Type" style="display:none;">
  <table class="small">
   <tr>
    <td>Name:</td>
    <td><input id="edit_type_name" size="53" value=""></td>
   </tr>
   <tr valign="top">
    <td>Description:</td>
    <td><textarea id="edit_type_description" rows="5" cols="50"></textarea></td>
   </tr>
  </table>
  <span onClick="add_type_to_experiment();" class='ui-button ui-corner-all'>Add</span>
</div>

<TMPL_INCLUDE NAME='widgets/AddAnnotation.tmpl'> <!-- Add/Edit Annotation Dialog -->

</TMPL_IF>



<TMPL_IF NAME="EDIT_EXPERIMENT_INFO">
<SCRIPT>
$(function() {
    $("#edit_source").autocomplete({
        source:
            function() {
                get_sources();
            },
        select:
            function(event, ui) {
                $("#edit_source").val( ui.item.label );
                $("#edit_source_id").val( ui.item.value );
                return false;
            }
    });
});
</SCRIPT>
<table class="small">
 <tr>
  <td>Name:</td>
  <td><input id="edit_name" type="textbox" size="53" value="<TMPL_VAR NAME='NAME'>"></td>
 </tr>
 <tr>
  <td>Description:</td>
  <td><textarea id="edit_desc" rows="5" cols="50"><TMPL_VAR NAME='DESC'></textarea></td>
 </tr>
 <tr>
  <td>Source:</td>
  <td>
   <input id="edit_source" size="53" value="<TMPL_VAR NAME='SOURCE'>">
   <input id="edit_source_id" type="hidden" value="<TMPL_VAR NAME='SOURCE_ID'>">
  </td>
 </tr>
 <tr>
  <td>Version:</td>
  <td><input id="edit_version" type="textbox" size="53" value="<TMPL_VAR NAME='VERSION'>"></td>
 </tr>
</table>
<br>
<span onClick="update_experiment_info();" class='ui-button ui-corner-all'>Update</span>
</TMPL_IF> <!-- EDIT_EXPERIMENT_INFO -->

<div id="export_irods_dialog" class="dialog_box hidden info" style="padding:20px;" title="Exporting to iPlant Data Store" align='center'>
        <span>Copying this experiment's data files to</span>
        <br><br>
        <a href="http://data.iplantcollaborative.org/" target=_new style="font-weight:bold">
            <tmpl_var name=irods_home>
        </a>
        <br><br>

        <span>Please wait ... <img src="picts/ajax-loader.gif"></span>
</div>
