<SCRIPT language="JavaScript">
// Begin Widget API -----------------------------------------------------------
// callback file_selected
// callback file_finished
// callback file_canceled
function get_selected_files() {
	var items = new Array();
	var transferring = 0;
	
	$('#file_table tr').each(
		function() {
			var path = $(this).data('path');
			if (path) {
				items.push(path);
			}
			else { // file is still transferring
				transferring++;
				return;
			}
		}
	);
	
	if (transferring) {
		return null;
	}
	
	return items;
}
// End Widget API -------------------------------------------------------------

$(document).ready(function() {
	$(function() { $("#tabs").tabs({selected:0}); });
	
	irods_get_path();
	
	set_ftp_button();
	$('#input_url').bind('keyup focus click', set_ftp_button);
	
	$('#input_upload_file').fileupload({
    	dataType: 'json',
    	formData: {
    		jquery_ajax: 1,
    		fname: 'upload_file',
    	},
    	add:
    		function(e, data) {
    			var filename = data.files[0].name;
				if ( !add_file_to_list(filename, 'file://'+filename) ) {
					alert('File already exists.');
				}
				else {
					data.submit();
				}
    		},
		done: 
			function(e, data) {
				finish_file_in_list('file://'+data.result.filename, data.result.path, data.result.size);
			}
	});	
});

function set_ftp_button() {
	if ( $('#input_url').val() ) {
		$('#ftp_get_button').removeClass('ui-state-disabled');
	}
	else {
		$('#ftp_get_button').addClass('ui-state-disabled');
	}
}

function add_file_to_list(filename, url) {
	var tr = $('#file_table tr').filter(
		function() {
			return (url == $(this).data('url'));
		}
	);
	
	if (tr.length) { // already exists
		return 0;
	}
	
	var tr = $('<tr style="font-style:italic;color:gray;"><td style="padding-right:15px">' + filename + '</td>' + '</tr>');
	var td = $('<td style="float:right;"><img src="picts/ajax-loader.gif"/></td>');
	$(tr).append(td).fadeIn();
	$(tr).data('url', url);
	if ("<TMPL_VAR NAME='FILE_SELECT_SINGLE'>") {
		$('#file_table').empty(); // remove all rows
	}
	$('#file_table').append(tr);
	
	// Call template user's generic hander if defined
	if (typeof file_selected == 'function') {
		file_selected(filename, url);
	}
	
	return 1;
}

function finish_file_in_list(url, path, size) {
	var tr = $('#file_table tr').filter(
		function() {
			return (url == $(this).data('url'));
		}
	);
	$(tr).data('path', path);
	$(tr).children().last().remove();
	$(tr).append( $('<td align="right">'+units(size)+' <span onClick="$(this).closest(\'tr\').fadeOut(function() { $(this).remove(); cancel_callback(); });" class="link ui-icon ui-icon-closethick"></span></td>').fadeIn() );
	$(tr).css('font-style', 'normal');
	$(tr).css('color', 'black');
	
	// Call template user's generic hander if defined
	if (typeof file_finished == 'function') {
		file_finished(size, url);
	}	
}

function cancel_callback() {
	// Call template user's generic hander if defined
	if (typeof file_canceled == 'function') {
		file_canceled();
	}
}

function activate_on_input(input_id, button_id) {
	if ( $('#'+input_id).val() ) {
		$('#'+button_id).removeClass('ui-state-disabled');
	}
	else {
		$('#'+button_id).addClass('ui-state-disabled');
	}
}

function irods_get_path (path) {
	$.ajax({
		data: {
			jquery_ajax: 1,
			fname: 'irods_get_path',
			path: path,
			timestamp: new Date().getTime()
		},
		success : function(data) {
			$('#ids_loading').hide();
			
			var result = jQuery.parseJSON(data);
			if (!result || !result.items) {
				return;
			}
			if (result.items.length > <TMPL_VAR NAME='MAX_IRODS_LIST_FILES'>) {
				alert("Too many files (" + filelist.length + ") at specified location, limit is <TMPL_VAR NAME='MAX_IRODS_LIST_FILES'>.");
				return;
			}
			
			$('#ids_table').html('');
			var parent_path = result.path.split('/').slice(0,-2).join('/') + '/';
			var up_icon  = "<span class='link' style='padding-left:15px;' onclick='irods_get_path(\""+parent_path+"\")'>Go Up<span class='ui-icon ui-icon-arrowreturnthick-1-n' /></span>";
			var get_icon = '';
			<TMPL_UNLESS NAME='DISABLE_IRODS_GET_ALL'>
			get_icon = "<span class='link' style='padding-left:15px;' onclick='irods_get_all_files(\""+result.path+"\")'>Get All<span class='ui-icon ui-icon-transferthick-e-w' /></span>";
			</TMPL_UNLESS>
			
			$('#ids_table').append('<tr><td colspan="3" style="white-space:nowrap;">'+result.path+up_icon+get_icon+'</td></tr>');
			
			result.items.forEach(
				function(obj) {
					var icon;
					if (obj.type == 'directory') {
						icon = '<span class="ui-icon ui-icon-folder-collapsed"></span>';
					}
					else {
						icon = '<span class="ui-icon ui-icon-document"></span>';
					}
					tr = $('<tr class="'+obj.type+'"><td style="white-space:nowrap;">'+icon+obj.name+'</td><td>'+obj.size+'</td><td>'+obj.timestamp+'</td></tr>');
					
					if (obj.type == 'directory') {
						$(tr).click( 
							function() {
								irods_get_path(obj.path);
							} 
						);						
					}
					else {
						$(tr).click( 
							function() {
								if ( add_file_to_list(obj.name, 'irods://'+obj.path) ) {
									irods_get_file(obj.path);
								}
								else {
									alert('File already exists.');
								}
							} 
						);					
					}
					
					$(tr).hover(
						function() {$(this).css({"cursor":"pointer", "background-color":"greenyellow"});},
						function() {$(this).css("background-color", "white");}
					);
						
					$('#ids_table').append(tr);
				}
			);		
		},
	});
}

function irods_get_file(path) {
	$.ajax({
		data: {
			jquery_ajax: 1,
			fname: 'irods_get_file',
			path: path,
		},
		success : function(data) {
			var obj = jQuery.parseJSON(data);
			finish_file_in_list('irods://'+path, obj.path, obj.size);
		},
	});	
}

function irods_get_all_files (path) {
	$.ajax({
		data: {
			jquery_ajax: 1,
			fname: 'irods_get_path',
			path: path,
			timestamp: new Date().getTime()
		},
		success : function(data) {
			var result = jQuery.parseJSON(data);
			if (!result || !result.items) {
				return;
			}
			if (result.items.length > <TMPL_VAR NAME='MAX_IRODS_TRANSFER_FILES'>) {
				alert("Too many files (" + filelist.length + ") at specified location, limit is <TMPL_VAR NAME='MAX_IRODS_TRANSFER_FILES'>.");
				return;
			}
			
			var count = 0;
			result.items.forEach(
				function(obj) {
					if (obj.type == 'file') {
						setTimeout(
							function() {
								if ( add_file_to_list(obj.name, 'irods://'+obj.path) ) {
									irods_get_file(obj.path);
								}
							},
							500 * count++
						);
					}
				}
			);		
		}
	});
}

function units(val) {
	if (val < 1024) { //>
		return val;
	}
	else if (val < 1024*1024) { //>
		return Math.ceil(val/1024) + 'K';
	}
	else if (val < 1024*1024*1024) { //>
		return Math.ceil(val/(1024*1024)) + 'M';
	}
	else {
		return Math.ceil(val/(1024*1024*1024)) + 'G';
	}
}

function ftp_get_file(url) {
	$.ajax({
		data: {
			jquery_ajax: 1,
			fname: 'ftp_get_file',
			url: url,
			timestamp: new Date().getTime()
		},
		success : function(data) {
			var obj = jQuery.parseJSON(data);
			if (!pageObj.timestamp || obj.timestamp >= pageObj.timestamp) {
				finish_file_in_list(url, obj.path, obj.size);
			}
		},
	});	
}

function load_from_ftp() {
	var url = $('#input_url').val();
	var timestamp = new Date().getTime();
	pageObj.timestamp = timestamp;
	
	$('#ftp_get_button').addClass('ui-state-disabled');
	
	$.ajax({
		data: {
			jquery_ajax: 1,
			fname: 'load_from_ftp',
			url: url,
			timestamp: timestamp,
		},
		success : function(data) {
			var filelist = jQuery.parseJSON(data);
			if (filelist.length > <TMPL_VAR NAME='MAX_FTP_FILES'>) {
				alert("Too many files (" + filelist.length + ") at specified location, limit is <TMPL_VAR NAME='MAX_FTP_FILES'>.");
				return;
			}
			
			pageObj.filecount = filelist.length;
			
			var count = 0;
			filelist.forEach(
				function(obj) {
					setTimeout(
						function() {
							if (add_file_to_list(obj.name, obj.url)) {
								ftp_get_file(obj.url);
							}
							if (--pageObj.filecount == 0) { // FTP transfer complete
								$('#ftp_get_button').removeClass('ui-state-disabled');
							}
						},
						500 * count++
					); 
				}
			);
		},
	});
}

function load_from_ncbi() {
	var accn = $('#input_accn').val();
	$.ajax({
		data: {
			jquery_ajax: 1,
			fname: 'ncbi_search',
			accn: accn,
			timestamp: new Date().getTime()
		},
		success : function(data) {
			var obj = jQuery.parseJSON(data);
			if (add_file_to_list(obj.name, 'ncbi://'+obj.id)) {
				finish_file_in_list('ncbi://'+obj.id, '', '');
			}
		},
	});	
}
</SCRIPT>

<div id='tabs' style='margin-top:0.5em;margin-bottom:1em;'>
  <ul>
    <li class="small"><a href="#tab-1">iPlant Data Store</a></li>
    <li class="small"><a href="#tab-2">FTP</a></li>
    <TMPL_IF NAME='ENABLE_NCBI'>
    <li class="small"><a href="#tab-3">NCBI</a></li>
    </TMPL_IF>
    <li class="small"><a href="#tab-4">Upload</a></li>
  </ul>

  <div id="tab-1" class="small">
    <div style="overflow-y:auto;height:200px;">
      <span id="ids_loading" style="color:gray;font-style:italic;">Loading <img id="wait_annotation" src="picts/ajax-loader.gif" /></span>
      <table id="ids_table" class='small'>
      </table>
    </div>
  </div> <!-- tab-1 -->

  <div id="tab-2" class="small">
    URL: <input id="input_url" size="30" />
    <span id="ftp_get_button" onClick="load_from_ftp();" class='ui-state-disabled ui-button ui-corner-all ui-button-go'> Get Files</span>
  </div> <!-- tab-2 -->

  <TMPL_IF NAME='ENABLE_NCBI'>
  <div id="tab-3" class="small">
    Accession#: <input id="input_accn" size="15" />
    <span id="ncbi_get_button" onClick="load_from_ncbi();" class='ui-button ui-corner-all ui-button-go'> Get</span>
  </div> <!-- tab-3 -->
  </TMPL_IF>

  <div id="tab-4" class="small">
    File: <input id="input_upload_file" name="input_upload_file" type="file" data-url='<TMPL_VAR NAME="PAGE_NAME">' />
  </div> <!-- tab-4 -->

</div> <!-- tabs -->
