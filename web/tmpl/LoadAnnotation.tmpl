<TMPL_IF NAME='MAIN'>
<SCRIPT language="JavaScript" type="text/javascript" src="./js/jquery.fileupload.js"></SCRIPT>

<SCRIPT language="JavaScript">
var LOG_POLL_TIME = 2000;
var timestamps = new Array();

$(document).ready(function(){
	$.ajaxSetup({
		type: "GET",
		url: '<TMPL_VAR NAME="PAGE_NAME">',
		dataType: "html",
		cache: false,
	});
	
	$(".dialog_box").dialog({autoOpen: false, width: 500});
	$('#load_dialog').dialog("widget").find('.ui-dialog-titlebar-close').hide();
	$('#load_dialog').dialog({modal: true, closeOnEscape: false})
	
	get_sources();

	$("#edit_genome").autocomplete({
		source:[],
		select: function(event, ui) {
			$('#edit_genome').val(ui.item.label);
			$('#gid').val(ui.item.value);
			return false; // Prevent the widget from inserting the value.
		},
		focus: function(event, ui) {
			//$("#edit_genome").val(ui.item.label);
			return false; // Prevent the widget from inserting the value.
		}
	});
	
	// Open status dialog
	if ('<TMPL_VAR NAME="OPEN_STATUS">') {
		$('#loading_msg').hide();
		$('#load_dialog').dialog('open'); 
		setTimeout(function() { get_load_log(); }, 0);
	}
});

function file_selected(filename, url) {
	$('#file_select_dialog').dialog('close');
	$('#select_file_button').hide();
}

function file_finished(size, url) {
}

function file_canceled() {
	$('#select_file_button').fadeIn();
}

function create_source() {
	var name = $('#edit_source_name').val();
	var desc = $('#edit_source_desc').val();
	var link = $('#edit_source_link').val();
	$.ajax({
		data: {
			fname: 'create_source',
			name: name,
			desc: desc,
			link: link,
		},
		success : function(name) {
			$('#create_new_source_dialog').dialog('close');
			if (name) {
				$('#edit_source').val(name);
			}
		}
	});
}

function reset_log() {
	$('#load_log').html('');
	$('#loading_msg').show();
	$('#finished_msg').hide();
	$('#error_msg').hide();
	$('#ok_button').hide();
	$('#finish_load_button').hide();
	$('#cancel_load_button').hide();
}

function check_login() {
	var logged_in = false;
	
	$.ajax({
		async: false,
		data: {
			fname: 'check_login',
		},
		success : function(rc) {
			logged_in = rc;
		}
	});
	
	return logged_in;
}

function load_annotation() {
	var name = $('#edit_name').val();
	var description = $('#edit_description').val();
	var version = $('#edit_version').val();
	var restricted = $('#restricted').is(':checked');
	var genome = $('#edit_genome').val();
	var gid = $('#gid').val();
	
	if (!version) {
		alert('Please specify a version.');
		return;
	}
	if (!genome || genome == 'Search') {
		alert('Please specify a genome.');
		return;
	}

	var source = $('#edit_source').val();
	if (!source || source == 'Search') {
		alert('Please specify a data source.');
		return;
	}	

	var items = get_selected_files();
	if (items == null) {
		alert('Files are still being transferred, please wait.');
		return;
	}
	else if (items.length == 0) {
		alert('Please select a data file.');
		return;
	}
	var json = JSON.stringify(items);
	
	var user_name = $('#edit_user').val(); // only exists if admin
	if (user_name == 'Search') { user_name = ''; }	
	
	// Prevent concurrent executions - issue 101
	if ( $("#load_dialog").dialog( "isOpen" ) )
		return;
	
	// Make sure user is still logged-in - issue 206
	if (!check_login()) {
		alert('Your session has expired, please log in again.');
		location.reload(true)
		return;
	}
	
	// Open status dialog right away - issue 101
	reset_log();
	$('#load_dialog').dialog('open');
	$('#load_log').html('Initializing ...');	
	
	$.ajax({
		data: {
			fname: 'load_annotation',
			load_id: '<TMPL_VAR NAME="LOAD_ID">',
			name: name,
			description: description,
			version: version,
			restricted: restricted,
			gid: gid,
			source_name: source,
			user_name: user_name,
			items: json,
			timestamp: new Date().getTime()
		},
		success : function() {
			// Add load_id to browser URL
			window.history.pushState({}, "Title", "<TMPL_VAR NAME='PAGE_NAME'>?load_id=<TMPL_VAR NAME='LOAD_ID'>");
			
			// Start status update
			setTimeout(function() { get_load_log(); }, LOG_POLL_TIME/2);
		}
		// TODO: handle error, show in status dialog
	});
}

function get_load_log() {
	timestamps['get_load_log'] = new Date().getTime();
	
	$.ajax({
		data: {
			fname: 'get_load_log',
			load_id: '<TMPL_VAR NAME="LOAD_ID">',
			timestamp: timestamps['get_load_log']
		},
		success : function(data) {
			if (!data) { // workaround for issue #45, jquery intermittently dropping payload
				setTimeout(function() { get_load_log(); }, LOG_POLL_TIME);
				return;
			}
			
			var obj = jQuery.parseJSON(data);

			/*if (obj.timestamp && obj.timestamp != timestamps['get_load_log']) {
				return;
			}*/
			
			$('#load_log').html(obj.log);
			var height = $('#load_log')[0].scrollHeight;
    		$("#load_log").animate({ scrollTop: height}, 500);
    						
			if (obj.status == 1) {
				$('#dataset_id').val( obj.dataset_id );
				$('#loading_msg').hide();
				$('#finished_msg').fadeIn();
				$('#ok_button').fadeIn();
				$('#finish_load_button').fadeIn();
			}
			else if (obj.status == -1) {
				$('#loading_msg').hide();
				$('#error_msg').fadeIn();
				$('#cancel_load_button').fadeIn();
			}
			else {
				setTimeout(function() { get_load_log(); }, LOG_POLL_TIME);
			}
		}
	});	
}

function continue_to_view() {
	//var dsid = $('#dataset_id').val();
	//window.location.href = "GenomeView.pl?dsid=" + dsid;
	window.location.href = "GenomeView.pl?gid=<TMPL_VAR NAME='GENOME_ID'>;tracks=features";
}

function wait_to_search (search_func, search_obj) {
	var search_term = search_obj.value;
	if (!search_term || search_term.length >= 2) {
		if (pageObj.time) {
			clearTimeout(pageObj.time);
		}
		
		pageObj.time = setTimeout(
			function() { 
				search_func(search_obj.value); 
			},
			500
		);
	}
}

function search_genomes (search_term) {
	$.ajax({
		data: {
			fname: 'search_genomes',
			search_term: search_term,
			timestamp: new Date().getTime()
		},
		success : function(data) {
			var obj = jQuery.parseJSON(data);
			if (obj.items) {
				obj.items.forEach(function(element) {
					element.label = element.label.replace(/&reg;/g, "\u00ae"); // (R)
				});
				$("#edit_genome").autocomplete({source: obj.items});
				$("#edit_genome").autocomplete("search");
			}
		},
	});
}

function search_users (search_term) {
	$.ajax({
		data: {
			fname: 'search_users',
			search_term: search_term,
			timestamp: new Date().getTime()
		},
		success : function(data) {
			var obj = jQuery.parseJSON(data);
			if (obj && obj.items) {
				$("#edit_user").autocomplete({source: obj.items});
				$("#edit_user").autocomplete("search");
			}
		},
	});
}

function get_sources () {
	$.ajax({
		data: {
			fname: 'get_sources',
		},
		success : function(data) {
			var obj = jQuery.parseJSON(data);
			if (obj) {
				$("#edit_source").autocomplete({source: obj});
			}
		},
	});
}

function more() {
	$('#more').hide();
	$('#edit_name').closest('tr').fadeIn();
	$('#edit_description').closest('tr').fadeIn();
}
</SCRIPT>


<table class="small ui-widget-content ui-corner-all">
  <tr>
    <td>Version:</td>
    <td><input id="edit_version" type="textbox" size="10" value="<TMPL_VAR NAME='NAME'>" spellcheck="false" /></td>
  </tr>
  <tr>
    <td>Source:</td>
    <td>
      <input id="edit_source" type="search" placeholder="Search" size="45" spellcheck="false" />
      <span id="new_source_button" onClick="$('#create_new_source_dialog').dialog('open'); activate_on_input('edit_source_name', 'create_source_button');" class='ui-button ui-corner-all'>New</span>
    </td>
  </tr> 
  <tr>
    <td>Restricted?</td>
    <td><input id="restricted" type="checkbox" checked></td>
  </tr>
  <tr>
    <td>Genome:</td>
    <td>
      <input id="edit_genome" type="search" placeholder="Search" spellcheck="false" onkeypress="wait_to_search(search_genomes, this);" size="58" value="<TMPL_VAR NAME='GENOME_NAME'>" />
      <input id="gid" type="hidden" value="<TMPL_VAR NAME='GENOME_ID'>" />
    </td>
  </tr>
  <tr>
    <td>Data file:</td>
    <td>
      <table id='file_table' class="small"></table>
      <span id="select_file_button" onClick="$('#file_select_dialog').dialog('open');" class='ui-button ui-corner-all'> Select Data File</span>
    </td>
  </tr>
  <tr id='more'>
    <td colspan="2"><span class="link" onclick="more();">more...</span></td>
  </tr>
  <tr style='display:none;'>
    <td>Name:</td>
    <td><input id="edit_name" type="textbox" size="58" value="<TMPL_VAR NAME='NAME'>" /></td>
  </tr>
  <tr style='display:none;'>
    <td>Description:</td>
    <td><textarea id="edit_description" rows=5 cols=50 ><TMPL_VAR NAME='DESC'></textarea></td>
  </tr>
</table>

<br>
<span onClick="load_annotation();" style="font-size:1em;" class='ui-button ui-corner-all ui-button-go'>Load Annotation</span>
<br>
<br>
<br>
<br>
<br>
<TMPL_INCLUDE NAME='widgets/Beta.tmpl'>


<div id="file_select_dialog" class="dialog_box" title="Select Data File ..." style="display:none;">
  <TMPL_INCLUDE NAME='widgets/FileSelect.tmpl'>
  <span onClick="$('#file_select_dialog').dialog('close');" style="float:right;" class="ui-button ui-corner-all">Done</span>
</div>



<div id="load_dialog" class="dialog_box" title="Loading Annotation ..." style="display:none;">
  <div id="load_log" class="small ui-widget-content ui-corner-all" style="overflow-y:auto;width:450px;height:200px;color:dimgray;">
  </div>
  <br>
  <div id="loading_msg" class="small">
    <span class="small" style="float:right;">Link: <a href='<TMPL_VAR NAME="LINK">'><TMPL_VAR NAME="LINK"></a></span>
    Please wait ... <img src="picts/ajax-loader.gif"/>
  </div>
  <span id="finished_msg" style="display:none;">Finished! <img src="picts/thumbs_up.png"></span>
  <span id="error_msg" style="display:none;">An error occurred <img src="picts/thumbs_down.png"></span>
  <input id="dataset_id" type="hidden" /> 
  <span id="ok_button" onClick="$('#load_dialog').dialog('close');" style="display:none;float:right;" class="ui-button ui-corner-all">OK</span>
  <span id="finish_load_button" onClick="continue_to_view();" style="display:none;float:right;" class="ui-button ui-corner-all">GenomeView</span>
  <span id="cancel_load_button" onClick="$('#load_dialog').dialog('close');" style="display:none;float:right;" class="ui-button ui-corner-all">Cancel</span>
</div>



<div id="create_new_source_dialog" class="dialog_box" title="Create New Source" style="display:none;">
  <table class="small">
    <tr>
      <td>Name:</td>
      <td><input id="edit_source_name" type="textbox" size="53" onkeyup="activate_on_input('edit_source_name', 'create_source_button');" /></td>
    </tr>
    <tr>
      <td>Description:</td>
      <td><textarea id="edit_source_desc" rows="5" cols="50" ></textarea></td>
    </tr>
    <tr>
      <td>Link:</td>
      <td><input id="edit_source_link" type="textbox" size="53" /></td>
    </tr>
  </table>
  <br>
  <span id="create_source_button" onClick="create_source();" class="ui-state-disabled ui-button ui-corner-all ui-button-go">Create</span>
</div>

</TMPL_IF> <!-- MAIN -->



<TMPL_IF NAME='LOGIN'>
<TMPL_INCLUDE NAME="widgets/Login.tmpl">
</TMPL_IF>



<TMPL_IF NAME='ADMIN_AREA'>
<br><br><hr>
<span style="color:dimgray;font-weight:bold;">Admin Functions</span><br>
<br>
</TMPL_IF>